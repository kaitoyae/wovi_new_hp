<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お知らせ - Wovi</title>
    <link rel="icon" type="image/png" href="images/logowhite.png">
    <meta property="og:image" content="https://wovi.net/images/logowhite.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:title" content="お知らせ - Wovi">
    <meta property="og:description" content="Woviの最新情報をお届けします">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://wovi.net/images/logowhite.png">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="components/header.js"></script>
    <script src="components/footer.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=General+Sans:wght@400;600&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* カラーパレット */
        :root {
            --wovi-green: #00A9A4;
            --spark-yellow: #FFD166;
            --off-white: #F9F9F7;
            --dark-text: #000000;
        }
        body {
            font-family: 'Yu Gothic', 'YuGothic', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: #ffffff;
            color: var(--dark-text);
        }
        .font-jp {
            font-family: 'Yu Gothic', 'YuGothic', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }
        /* 見出し用のフォント */
        .font-heading {
            font-family: 'General Sans', 'Noto Sans JP', sans-serif;
        }
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        .content-wrapper {
            position: relative;
            z-index: 1;
        }
        .btn-creative {
            border: 1px solid var(--dark-text);
            color: var(--dark-text);
            transition: all 0.3s ease;
        }
        .btn-creative:hover {
            background-color: var(--spark-yellow);
            color: var(--dark-text);
            border-color: var(--spark-yellow);
        }
        .glass-section {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .article-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <canvas id="three-canvas"></canvas>

    <div class="content-wrapper min-h-screen flex flex-col">
        <!-- ヘッダー -->
        <div id="header-placeholder"></div>

        <!-- メインコンテンツ -->
        <main class="flex-grow pt-32">
            <!-- お知らせセクション -->
            <section class="py-20 md:py-32">
                <div class="container mx-auto px-6 max-w-6xl">
                    <div class="text-center mb-16">
                        <h1 class="text-4xl md:text-5xl font-semibold font-jp">
                            お知らせ
                        </h1>
                        <p class="mt-4 text-lg text-gray-600 font-jp">
                            Woviの最新情報をお届けします
                        </p>
                    </div>
                    
                    <!-- Note記事一覧 -->
                    <div id="note-articles" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- 記事はJavaScriptで動的に読み込まれます -->
                        <!-- ローディングスケルトン -->
                        <div class="article-card rounded-lg shadow-md overflow-hidden">
                            <div class="loading-skeleton h-48"></div>
                            <div class="p-6">
                                <div class="loading-skeleton h-4 w-24 mb-2"></div>
                                <div class="loading-skeleton h-6 mb-3"></div>
                                <div class="loading-skeleton h-4 mb-1"></div>
                                <div class="loading-skeleton h-4 w-3/4"></div>
                            </div>
                        </div>
                        <div class="article-card rounded-lg shadow-md overflow-hidden">
                            <div class="loading-skeleton h-48"></div>
                            <div class="p-6">
                                <div class="loading-skeleton h-4 w-24 mb-2"></div>
                                <div class="loading-skeleton h-6 mb-3"></div>
                                <div class="loading-skeleton h-4 mb-1"></div>
                                <div class="loading-skeleton h-4 w-3/4"></div>
                            </div>
                        </div>
                        <div class="article-card rounded-lg shadow-md overflow-hidden">
                            <div class="loading-skeleton h-48"></div>
                            <div class="p-6">
                                <div class="loading-skeleton h-4 w-24 mb-2"></div>
                                <div class="loading-skeleton h-6 mb-3"></div>
                                <div class="loading-skeleton h-4 mb-1"></div>
                                <div class="loading-skeleton h-4 w-3/4"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- noteページへのリンク -->
                    <div class="text-center mt-12">
                        <a href="https://note.com/wovi/all" target="_blank" rel="noopener noreferrer" class="btn-creative font-semibold py-3 px-8 rounded-full">
                            noteで記事を見る
                        </a>
                    </div>
                </div>
            </section>
        </main>

        <!-- フッター -->
        <div id="footer-placeholder"></div>
    </div>

    <script>
        // Three.jsのセットアップ
        let scene, camera, renderer;
        const branches = [];
        // より鮮やかなカラーパレット
        const colors = [
            0x00A9A4, // Wovi Green
            0xFFD166, // Spark Yellow
            0xf472b6, // Bright Pink
            0x9333ea, // Bright Violet
            0x2563eb, // Bright Blue
            0xdc2626, // Bright Red
            0x65a30d, // Bright Lime
            0xf59e0b, // Bright Orange
            0x06b6d4, // Bright Cyan
        ];

        // 枝を表現するクラス
        class Branch {
            constructor(startPos, color) {
                this.points = [startPos.clone()];
                this.maxPoints = 50 + Math.random() * 50;
                this.isGrowing = true;
                this.velocity = new THREE.Vector3(
                    (Math.random() - 0.5),
                    (Math.random() - 0.5),
                    (Math.random() - 0.5)
                ).normalize(); // 初期方向をランダムに設定

                // 線を太く、色を鮮やかにする（4倍の太さ）
                const material = new THREE.LineBasicMaterial({ color, transparent: true, opacity: 0.9, linewidth: 100 });
                const geometry = new THREE.BufferGeometry().setFromPoints(this.points);
                this.line = new THREE.Line(geometry, material);
                scene.add(this.line);
            }

            grow() {
                if (!this.isGrowing) return;

                const lastPoint = this.points[this.points.length - 1];
                
                // === 適度に曲がる自然な動きのロジック ===
                // 1. 慣性を少し弱めて、適度な曲がりを許可
                this.velocity.multiplyScalar(0.985);

                // 2. 中心から外へ広がる力
                const outwardVector = lastPoint.clone().normalize().multiplyScalar(0.012);
                this.velocity.add(outwardVector);

                // 3. 適度なゆらぎで自然な曲線を作る（直線にならないように）
                const wobble = new THREE.Vector3(
                    (Math.random() - 0.5),
                    (Math.random() - 0.5),
                    (Math.random() - 0.5)
                ).multiplyScalar(0.04);
                this.velocity.add(wobble);

                // 4. 前の方向との平均を軽くして、より曲がりやすく
                if (this.points.length > 2) {
                    const prevDirection = this.points[this.points.length - 1].clone()
                        .sub(this.points[this.points.length - 2]).normalize();
                    this.velocity.lerp(prevDirection, 0.15); // より軽い平滑化
                }

                // 5. 時々方向を少し変更して曲がりを作る
                if (this.points.length % 8 === 0) {
                    const randomTurn = new THREE.Vector3(
                        (Math.random() - 0.5),
                        (Math.random() - 0.5),
                        (Math.random() - 0.5)
                    ).normalize().multiplyScalar(0.15);
                    this.velocity.add(randomTurn);
                }
                // === ロジックここまで ===

                // 速度を正規化して、適切な速さに保つ
                this.velocity.normalize().multiplyScalar(0.05);

                const newPoint = lastPoint.clone().add(this.velocity);
                this.points.push(newPoint);

                this.line.geometry.setFromPoints(this.points);

                if (this.points.length > this.maxPoints) {
                    this.isGrowing = false;
                }
                
                // 枝分かれのロジック（より自然な分岐）
                if (Math.random() < 0.015 && branches.length < 120 && this.points.length > 10) {
                    // 新しいブランチは親の方向を滑らかに引き継ぎつつ、自然な角度で分岐する
                    const newVelocity = this.velocity.clone().applyAxisAngle(
                        new THREE.Vector3(Math.random() - 0.5, Math.random() - 0.5, Math.random() - 0.5).normalize(),
                        (Math.random() - 0.5) * 0.5 // より小さい分岐角度でより自然に
                    );
                    const newBranch = new Branch(newPoint, this.line.material.color);
                    newBranch.velocity = newVelocity.multiplyScalar(0.8); // 子枝は少し遅く成長
                    branches.push(newBranch);
                }
            }
        }

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10;
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas'), antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // 最初の枝を生成
            for (let i = 0; i < 5; i++) {
                const color = colors[Math.floor(Math.random() * colors.length)];
                branches.push(new Branch(new THREE.Vector3(0,0,0), color));
            }

            window.addEventListener('resize', onWindowResize);
            window.addEventListener('scroll', onScroll);
            
            // 時間経過で新しい枝を追加
            setInterval(addNewBranch, branchInterval);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        let lastBranchTime = 0;
        const branchInterval = 1000; // 1秒ごとに新しい枝を追加
        
        // スクロール位置を追跡
        let scrollY = 0;
        let autoRotation = true;
        let lastInteractionTime = Date.now();
        let animationStartTime = Date.now();
        const rotationDelay = 3000; // 3秒後に回転開始
        
        function addNewBranch() {
            if (branches.length < 120) {
                const xPos = (Math.random() - 0.5) * 8;
                const yPos = (Math.random() - 0.5) * 8;
                const zPos = (Math.random() - 0.5) * 8;
                
                const color = colors[Math.floor(Math.random() * colors.length)];
                branches.push(new Branch(new THREE.Vector3(xPos, yPos, zPos), color));
            }
        }
        
        // スクロールイベントハンドラー
        function onScroll() {
            scrollY = window.scrollY / window.innerHeight;
            autoRotation = false;
            lastInteractionTime = Date.now();
        }

        function animate() {
            requestAnimationFrame(animate);

            branches.forEach(branch => branch.grow());
            
            const now = Date.now();
            const timeSinceStart = now - animationStartTime;
            
            // アニメーション開始から一定時間後に回転を開始
            if (timeSinceStart > rotationDelay) {
                // 自動回転または手動制御の判定
                if (now - lastInteractionTime > 3000) {
                    autoRotation = true;
                }
                
                if (autoRotation) {
                    // 自動回転（速度を半分に）
                    scene.rotation.x += 0.0015;
                    scene.rotation.y += 0.0025;
                } else {
                    // スクロールベースの回転（速度を1/5に）
                    const targetRotationX = scrollY * Math.PI * 0.2;
                    const targetRotationY = scrollY * Math.PI * 0.15;
                    scene.rotation.x += (targetRotationX - scene.rotation.x) * 0.005;
                    scene.rotation.y += (targetRotationY - scene.rotation.y) * 0.005;
                }
            }

            renderer.render(scene, camera);
        }

        // Note記事を取得する関数（画像取得改善版）
        async function loadNoteArticles() {
            const noteContainer = document.getElementById('note-articles');
            
            // 複数のnoteAPIエンドポイントとRSSから取得
            const fetchPromises = [
                // v2 API（現在使用中）
                fetch('https://corsproxy.io/?' + encodeURIComponent('https://note.com/api/v2/creators/wovi/contents?kind=note&page=1')),
                // v1 API（より詳細な情報が取得できる可能性）
                fetch('https://corsproxy.io/?' + encodeURIComponent('https://note.com/api/v1/creators/wovi/contents?kind=note&page=1')),
                // RSS
                fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent('https://note.com/wovi/rss'))
            ];
            
            try {
                const [noteV2Response, noteV1Response, rssResponse] = await Promise.all(fetchPromises);
                const [noteV2Data, noteV1Data, rssData] = await Promise.all([
                    noteV2Response.json().catch(() => null),
                    noteV1Response.json().catch(() => null), 
                    rssResponse.json().catch(() => null)
                ]);
                
                console.log('noteV2データ:', noteV2Data);
                console.log('noteV1データ:', noteV1Data);
                console.log('RSSデータ:', rssData);
                
                // RSS画像情報をマップ化
                const rssImages = {};
                if (rssData.items) {
                    rssData.items.forEach(item => {
                        if (item.link && item.thumbnail) {
                            rssImages[item.link] = item.thumbnail;
                        }
                    });
                }
                
                console.log('RSS画像マップ:', rssImages);
                
                // より詳細な画像情報を含むデータソースを選択
                let noteData = null;
                let dataSource = '';
                
                if (noteV1Data?.data?.contents) {
                    noteData = noteV1Data;
                    dataSource = 'v1 API';
                    console.log('v1 APIデータを使用');
                } else if (noteV2Data?.data?.contents) {
                    noteData = noteV2Data;
                    dataSource = 'v2 API';
                    console.log('v2 APIデータを使用');
                }
                
                if (noteData?.data?.contents) {
                    // デバッグ用：データ構造を詳しく確認
                    console.log(`${dataSource}データ構造:`, JSON.stringify(noteData.data.contents[0], null, 2));
                    
                    const articles = noteData.data.contents.map(item => {
                        // 画像URLの候補を全て確認
                        let imageUrl = item.thumbnailExternalUrl || 
                                     item.eyecatch?.src || 
                                     item.eyecatch?.url ||
                                     item.thumbnail?.url ||
                                     item.thumbnail?.src ||
                                     item.coverImageUrl ||
                                     item.image?.url ||
                                     '';
                        
                        // 見出し画像がない場合は本文から画像を抽出
                        if (!imageUrl && item.body) {
                            const imgMatch = item.body.match(/<img[^>]+src="([^"]+)"/);
                            if (imgMatch) {
                                imageUrl = imgMatch[1];
                            }
                        }
                        
                        // RSSから画像を取得を試す
                        if (!imageUrl && item.noteUrl && rssImages[item.noteUrl]) {
                            imageUrl = rssImages[item.noteUrl];
                            console.log(`RSS画像を使用: ${imageUrl}`);
                        }
                        
                        // 個別記事APIから詳細情報を取得（非同期で詳細データを取得）
                        if (!imageUrl && item.noteUrl) {
                            const noteKey = item.key || item.noteUrl.split('/').pop();
                            if (noteKey) {
                                // 個別記事の詳細API
                                fetch('https://corsproxy.io/?' + encodeURIComponent(`https://note.com/api/v2/notes/${noteKey}`))
                                    .then(res => res.json())
                                    .then(detailData => {
                                        console.log(`個別記事 ${noteKey} 詳細:`, detailData);
                                        if (detailData.data) {
                                            const detailImageUrl = detailData.data.thumbnailExternalUrl || 
                                                                 detailData.data.eyecatch?.src ||
                                                                 detailData.data.eyecatch?.url;
                                            if (detailImageUrl) {
                                                console.log(`個別APIで画像発見: ${detailImageUrl}`);
                                                // 画像を動的に更新
                                                const imgElement = document.querySelector(`img[alt="${item.name}"]`);
                                                if (imgElement) {
                                                    imgElement.src = detailImageUrl;
                                                }
                                            }
                                        }
                                    })
                                    .catch(err => console.warn(`個別記事取得失敗 ${noteKey}:`, err));
                            }
                        }
                        
                        // 最後の手段：ユーザープロフィール画像を使用
                        let isUserProfile = false;
                        if (!imageUrl && item.user?.userProfileImagePath) {
                            imageUrl = item.user.userProfileImagePath;
                            isUserProfile = true;
                            console.log(`ユーザープロフィール画像を使用: ${imageUrl}`);
                        }
                        
                        console.log(`記事: ${item.name}, 画像URL: ${imageUrl}`);
                        
                        return {
                            title: item.name || '',
                            link: item.noteUrl || '',
                            pubDate: item.publishAt || '',
                            description: (item.body || '').replace(/<[^>]*>/g, '').substring(0, 200),
                            thumbnail: imageUrl,
                            isUserProfile: isUserProfile
                        };
                    });
                    
                    console.log(`記事取得成功: ${articles.length}件`);
                    
                    // 記事を表示
                    noteContainer.innerHTML = '';
                    articles.forEach(article => {
                        const articleElement = createArticleElement({
                            title: article.title,
                            link: article.link,
                            pubDate: new Date(article.pubDate),
                            description: article.description,
                            thumbnail: article.thumbnail,
                            isUserProfile: article.isUserProfile
                        });
                        noteContainer.appendChild(articleElement);
                    });
                    return;
                }
            } catch (error) {
                console.warn('noteAPI取得エラー:', error);
                
                // noteAPIが失敗した場合、RSSのみで処理
                try {
                    const rssResponse = await fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent('https://note.com/wovi/rss'));
                    const rssData = await rssResponse.json();
                    
                    if (rssData.items) {
                        console.log('RSSフォールバック成功');
                        const articles = rssData.items.map(item => ({
                            title: item.title || '',
                            link: item.link || '',
                            pubDate: item.pubDate || '',
                            description: (item.description || '').replace(/<[^>]*>/g, '').substring(0, 200),
                            thumbnail: item.thumbnail || '',
                            isUserProfile: false
                        }));
                        
                        noteContainer.innerHTML = '';
                        articles.forEach(article => {
                            const articleElement = createArticleElement({
                                title: article.title,
                                link: article.link,
                                pubDate: new Date(article.pubDate),
                                description: article.description,
                                thumbnail: article.thumbnail,
                                isUserProfile: article.isUserProfile
                            });
                            noteContainer.appendChild(articleElement);
                        });
                        return;
                    }
                } catch (rssError) {
                    console.warn('RSSフォールバックも失敗:', rssError);
                }
            }
            
            // 全ての取得方法が失敗した場合の表示
            noteContainer.innerHTML = `
                <div class="col-span-full text-center">
                    <div class="article-card rounded-lg p-8">
                        <p class="text-gray-600 font-jp mb-4">記事の読み込みに失敗しました</p>
                        <a href="https://note.com/wovi/all" target="_blank" rel="noopener noreferrer" class="inline-block btn-creative py-2 px-6 rounded-full">
                            noteで記事を見る
                        </a>
                    </div>
                </div>
            `;
        }


        // 記事要素を作成する関数
        function createArticleElement(article) {
            const articleElement = document.createElement('div');
            articleElement.className = 'article-card rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300';
            
            const imageHtml = article.thumbnail 
                ? `<div class="h-48 overflow-hidden ${article.isUserProfile ? 'flex items-center justify-center' : ''}" style="${article.isUserProfile ? 'background-color: white;' : ''}">
                       <img src="${article.thumbnail}" alt="${article.title}" 
                            class="${article.isUserProfile ? '' : 'w-full h-full'} object-cover hover:scale-105 transition-transform duration-300" 
                            style="${article.isUserProfile ? 'max-width: 50%; max-height: 50%; object-fit: contain;' : 'max-width: 100%; max-height: 100%; object-fit: cover;'}"
                            onerror="console.log('画像読み込み失敗: ${article.thumbnail}'); this.parentElement.innerHTML='<div class=\\'h-48 flex items-center justify-center\\' style=\\'background-color: var(--wovi-green);\\'>\\n</div>'"
                            onload="console.log('画像読み込み成功: ${article.thumbnail}')">
                   </div>`
                : `<div class="h-48 flex items-center justify-center" style="background-color: var(--wovi-green);">
                   </div>`;

            articleElement.innerHTML = `
                ${imageHtml}
                <div class="p-6">
                    <div class="text-sm text-gray-500 mb-2">
                        ${article.pubDate.toLocaleDateString('ja-JP')}
                    </div>
                    <h3 class="text-lg font-semibold font-jp mb-3 line-clamp-2">
                        ${article.title}
                    </h3>
                    <p class="text-gray-600 text-sm leading-relaxed mb-4 line-clamp-3">
                        ${article.description.substring(0, 120)}...
                    </p>
                    <a href="${article.link}" target="_blank" rel="noopener noreferrer" class="inline-block text-sm font-medium py-2 px-4 rounded-full border border-gray-300 hover:bg-gray-50 transition-colors duration-200">
                        記事を読む
                    </a>
                </div>
            `;
            
            return articleElement;
        }

        // ページロード時に実行
        window.addEventListener('DOMContentLoaded', function() {
            // ヘッダーとフッターをロード
            document.getElementById('header-placeholder').innerHTML = createHeader();
            document.getElementById('footer-placeholder').innerHTML = createFooter();
            
            // ヘッダーのイベントリスナーを初期化
            initializeHeaderEvents();
            
            init();
            animate();
            loadNoteArticles();
        });
    </script>

</body>
</html>